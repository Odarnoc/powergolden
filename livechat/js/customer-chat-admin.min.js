!function(t,e){t.Application=e.extend({model:{},view:{},service:{},template:{}},Backbone.Events)}(window,_),function(t,e,i){t.SoundPlayer=function(){this.play=function(t){};var t=[];this.addSounds=function(e){t.push(e)};var s=this;e.setup({url:i.rootPath+"swf/",onready:function(){if(s.play=function(t){e.play(t)},s.addSounds=function(t){for(var s in t)e.createSound({id:s,url:i.rootPath+t[s],autoLoad:!0,autoPlay:!1,volume:100})},s.addSounds({message:i.ui.messageSound}),t.length>0)for(var o=0;o<t.length;o++)s.addSounds(t[o])}})}}(window.Application,soundManager,chatConfig),function(t,e,i,s){t.UISettingsModel=Backbone.Model.extend({initialize:function(){this.fetch()},fetch:function(){var t=this;e.get(i.getSettingsPath,function(e){e.success&&t.set(e.settings)})},save:function(){arguments.length>0&&this.set.apply(this,arguments),this.trigger("request");var t=this;e.post(i.updateSettingsPath,this.attributes,function(){t.trigger("sync")})},reset:function(){var t=this;e.post(i.resetSettingsPath,function(e){e.success&&(t.set(e.settings,{silent:!0}),t.trigger("change"))})}})}(window.Application,jQuery,window.chatConfig,_),function(t,e,i){t.LogsModel=Backbone.Model.extend({fetch:function(){this.trigger("request");var t=this;e.get(i.getLogsPath,function(e){t.set("content",e),t.trigger("sync")})},set:function(t,e){var i="string"==typeof this.attributes[t]?this.attributes[t].length:0;this.attributes[t]=e;var s="string"==typeof this.attributes[t]?this.attributes[t].length:0;s!==i&&(this.trigger("change:"+t,this,this.attributes[t]),this.trigger("change",this))},clear:function(t,s){this.trigger("request");var o=this;e.get(i.clearLogsPath,function(e){e.success?(o.set("content",""),o.trigger("sync"),t&&t()):s&&s()})}})}(window.Application,jQuery,window.chatConfig),function(t,e){t.AdminSettingsModel=Backbone.Model.extend({defaults:{sound:!0,scroll:!0,emots:!0},initialize:function(){this.fetch(),this.on("change",this.save,this)},save:function(){e.cookie("customer-chat-admin-settings",JSON.stringify(this.attributes))},fetch:function(){e.cookie("customer-chat-admin-settings")&&this.set(JSON.parse(e.cookie("customer-chat-admin-settings")))}})}(window.Application,jQuery),function(t,e){t.MessageModel=Backbone.Model.extend({defaults:{author:"",body:"",toAuthor:"all",toAuthorMail:""},initialize:function(t,e){if(this.options=e||{},t){if("string"==typeof t.datetime?this.set("time",new Date(t.datetime.replace(/-/g,"/"))):"object"==typeof t.datetime&&this.set("time",t.datetime),"string"==typeof t.from_user_info&&"all"!==t.from_user_info)try{t.from_user_info=JSON.parse(t.from_user_info)}catch(i){}if("object"==typeof t.from_user_info){var s=t.from_user_info;this.fromUser=s,0===this.get("author").length&&this.set("author",s.name),this.has("authorMail")||this.set("authorMail",s.mail)}if("string"==typeof t.to_user_info&&"all"!==t.to_user_info)try{t.to_user_info=JSON.parse(t.to_user_info)}catch(i){}if("object"==typeof t.to_user_info){var o=t.to_user_info;this.toUser=o,this.set("toAuthor",o.name),this.set("toAuthorMail",o.mail)}}},getAge:function(){var t=Math.floor((new Date).getTime()/1e3),i=Math.floor(this.get("time").getTime()/1e3-(this.options.localMessage?0:e.serverTimeDifference));return Math.ceil(t-i)},getReadableName:function(){var t=this.get("author");return-1!==t.lastIndexOf("-")?t.slice(0,t.lastIndexOf("-")):t},getToUserReadableName:function(){var t=this.get("toAuthor");return-1!==t.lastIndexOf("-")?t.slice(0,t.lastIndexOf("-")):t},getTalkName:function(){var t=this.get("toAuthor");return this.getReadableName()+(t?"/"+(-1!==t.lastIndexOf("-")?t.slice(0,t.lastIndexOf("-")):t):"")}})}(window.Application,window.chatConfig),function(t){t.UserModel=Backbone.Model.extend({initialize:function(t){if("string"==typeof t.info)try{t.info=JSON.parse(t.info)}catch(e){}},getAge:function(){this.chat=t.model.chat;var e=(new Date).getTime()/1e3,i=this.get("time").getTime()/1e3;return Math.ceil(e-i)},getReadableName:function(){var t=this.get("name");return-1!==t.lastIndexOf("-")?t.slice(0,t.lastIndexOf("-")):t},hasRole:function(t){return-1!==this.get("roles").indexOf(t)}})}(window.Application),function(t,e,i,s){t.ChatViewModel=Backbone.Model.extend({defaults:{name:"anonymous",mail:""}})}(window.Application,jQuery,window.chatConfig,_),function(t,e,i,s){var o=t.AdminChatModel=Backbone.Model.extend({defaults:{name:"anonymous",mail:""},usersCache:{},guestsCache:{},lastMessages:[],readMessages:{},operatorsReady:!1,lastTypingUpdate:0,talkingUsersIds:[],initialize:function(){this.user=t.model.user,this.once("change:operators",function(){this.operatorsReady=!0},this),this.on("user:store",this.handleTypingUser,this),this.manageConnection()},checkUsers:function(){var t=this;e.get(i.getOnlineUsersPath,function(e){e.success&&t.trigger("users:online",e.users)})},keepAlive:function(){e.get(i.keepAlivePath)},handleTypingUser:function(t){-1===this.talkingUsersIds.indexOf(t.id)&&this.talkingUsersIds.push(t.id)},updateTypingStatus:function(t){var s=(new Date).getTime();this.lastTypingUpdate+o.POLLING_INTERVAL<s&&(this.lastTypingUpdate=s,e.post(i.updateTypingStatusPath,{secondUserId:t,status:!0}))},getTypingStatus:function(){if(this.talkingUsersIds.length>0){var t=this;e.post(i.getTypingStatusPath,{ids:this.talkingUsersIds},function(e){if(e.success){var i=t.filterTyping(e.results);i.length>0&&t.trigger("users:typing",i)}})}},filterTyping:function(t){var e=[];for(var i in t)t[i]&&e.push(i);return e},getMessages:function(){var t=this;e.get(i.newMessagesPath,function(e){e=e.messages,e.length>0&&(e=t.filterNewMessages(e),t.loadUsersData(e,function(){t.trigger("messages:new",e)}))})},getLastMessages:function(t,s,o){e.post(i.lastMessagesPath,{lastMsgId:s,guestId:t}).success(function(t){o(t.messages)}).fail(function(){o([])})},storeUser:function(t){this.usersCache[t.id]=t,this.trigger("user:store",t)},storeGuest:function(t){this.guestsCache[t.id]=t},clearOperator:function(t){delete this.usersCache[t.id]},clearGuest:function(t){delete this.guestsCache[t.id]},loadOperators:function(){var t=this;e.get(i.listOperatorsPath,function(e){s.each(e.users,function(e){t.storeUser(e)}),t.trigger("change:operators")})},getOperators:function(){var t=[];for(var e in this.usersCache)t.push(this.usersCache[e]);return t},getOperator:function(t){return this.usersCache[t]},getGuest:function(t){return this.guestsCache[t]},saveOperator:function(t){var o=s.clone(t);o.roles=o.roles.join(",");var n=this;e.post(i.saveOperatorPath,o,function(e){e.success?(e.id&&(t.id=e.id),n.storeUser(t),n.trigger("change:operators operator:saved",t)):n.trigger("operator:saveError",e.errors)})},deleteOperator:function(t){this.clearOperator(t);var s=this;e.post(i.deleteOperatorPath,t,function(t){s.trigger(t.success?"change:operators operator:deleted":"operator:deleteError")})},loadUsersData:function(t,s){for(var o=this,n=0,a=0;a<t.length;a++){var r=t[a];this.usersCache[r.from_id]||(n++,e.post(i.getUserPath,{id:r.from_id}).success(function(t){t.success&&o.storeUser(t.user)}).always(function(){n--,0>=n&&s()}))}0>=n&&s()},getOperatorName:function(t){return this.usersCache[t]&&this.usersCache[t].name},queryHistory:function(t,s,o){e.post(i.queryHistoryPath,{query:JSON.stringify(t)},function(t){s(t)}).fail(o)},clearHistory:function(t,s){e.post(i.clearHistoryPath,function(e){e.success?t(e):s(e)},"JSON").fail(s)},sendMessage:function(t){var s={to:t.get("to"),body:t.get("body")},o=this;e.post(i.sendMessagePath,s,function(t){t.success?o.trigger("messages:sent",t.to,t.message):o.trigger("messages:sendError")})},manageConnection:function(){function t(){e.user.hasRole("OPERATOR")&&(e.getMessages(),e.keepAlive(),e.getTypingStatus()),e.checkUsers()}var e=this;setInterval(t,o.POLLING_INTERVAL),t()},filterNewMessages:function(t){var e=[];return s.each(t,function(t){var i=this.readMessages[t.talk_id];(!i||t.id>i)&&(e.push(t),this.readMessages[t.talk_id]=t.id)},this),e}},{POLLING_INTERVAL:5e3})}(window.Application,jQuery,window.chatConfig,_),function(t,e,i){var s=/(\w+:\/\/)?([\da-z\.\-@]+)\.([a-z\.]{2,})([?&=%#;\/\w\.-]*)*\/?/g,o=t.MessageView=Backbone.View.extend({initialize:function(){this.settings=t.model.settings,this.listenTo(this.model,"change",this.render),this.render(),this.$el.hide(),this.$el.fadeIn("fast")},render:function(){this.$el.html(i(t.template.message)),this.$time=this.$(".customer-chat-content-message-time");var e=this.model.get("body").split("<").join("&lt;").split(">").join("&gt;");e=this.prepareMessage(e),this.$(".customer-chat-content-message-author").html(this.model.getReadableName()||this.model.get("author")),this.$(".customer-chat-content-message-body").html(e),this.updateTime(!0),"operator"==this.model.get("authorType")&&this.$(".customer-chat-content-message").removeClass("customer-chat-content-message").addClass("customer-chat-content-message-operator"),t.UserInfoPopoverView&&new t.UserInfoPopoverView({model:this.model,button:this.$(".customer-chat-content-message-author")[0]})},prepareMessage:function(t){return t=t.replace(s,function(t,e){return-1!==t.indexOf("@")?t:-1!==t.indexOf("..")?t:o.createLinkElement(t,(e?"":"http://")+t)})},updateTime:function(t){var i=this.model.getAge(),s=Math.floor(i/60),o=Math.floor(s/60),n=Math.floor(o/24),a=Math.floor(n/7),r=this.model.get("time"),h=(r.getDate()<10?"0":"")+r.getDate()+"."+(r.getMonth()+1<10?"0":"")+(r.getMonth()+1)+"."+r.getFullYear(),l=(r.getHours()<10?"0":"")+r.getHours()+":"+(r.getMinutes()<10?"0":"")+r.getMinutes()+":"+(r.getSeconds()<10?"0":"")+r.getSeconds(),c=h+" "+l;if(this.options.fullDate)return void this.$time.html(c);var d=a>0?c:n>0?n+" "+e.ui.timeDaysAgo:o>0?o+" "+e.ui.timeHoursAgo:s>0?s+" "+e.ui.timeMinutesAgo:Math.max(i-i%5,1)+" "+e.ui.timeSecondsAgo;if(this.$time.html(d),t){var u=n>0?-1:o>0?60*(60-s%60)*60:s>5?60*(5-s%5):s>0?60:10-i%10;if(-1==u)return;var m=this;this.timerId=setTimeout(function(){m.updateTime(!0)},1e3*u)}},clean:function(){return this.timerId&&clearTimeout(this.timerId),this}},{createLinkElement:function(t,e){return t.length>40,'<a href="'+e+'" target="_blank">'+t+"</a>"}})}(window.Application,window.chatConfig,jQuery),function(t,e){t.ChatBoxView=Backbone.View.extend({initialize:function(){this.settings=t.model.settings,this.$wrapper=this.$(".customer-chat-content-messages-wrapper"),this.$el.mCustomScrollbar(),this.messageViews=[]},addMessage:function(e,i,s){var o=new t.MessageView({model:e,fullDate:this.options.fullDate});this.messageViews.push(o),this.$wrapper.append(o.el);var n=this;setTimeout(function(){n.updateScroller(),s?i&&n.$el.mCustomScrollbar("scrollTo","bottom"):(n.settings.get("scroll")||i)&&n.$el.mCustomScrollbar("scrollTo","bottom")},200)},clear:function(){for(var t=0;t<this.messageViews.length;t++)this.messageViews[t].remove().clean();this.$wrapper.html(""),this.messageViews=[]},updateScroller:function(){this.$el.mCustomScrollbar("update")}})}(window.Application,jQuery),function(t,e,i,s){t.TabsView=Backbone.View.extend({events:{"mousedown .customer-chat-tab":"switchTab","click .customer-chat-tab-prev":"prevButtons","click .customer-chat-tab-next":"nextButtons"},currentTab:0,prevWinSize:{width:0,height:0},initialize:function(){this.$window=e(window),this.$tabContentContainer=this.$el,this.$container=this.$(".customer-chat-tabs"),this.$buttonsContainer=this.$(".customer-chat-tabs-wrapper"),this.$buttons=this.$(".customer-chat-tab-button"),this.$tabs=this.$el.children(".customer-chat-tab-content"),this.$prev=this.$(".customer-chat-tab-prev"),this.$next=this.$(".customer-chat-tab-next"),this.$el.is(":visible")?this.render():(this.$el.show(),this.render(),this.$el.hide()),this.updateOnResize()},addTab:function(t){var i=e(t.button);this.$buttonsContainer.append(i),this.$buttons=this.$buttons.add(i);var s=e(t.content);return this.$tabs=this.$tabs.add(s),this.$tabContentContainer.append(s),this.render(),s},removeTab:function(t){var e=this.$buttons.eq(t);e.remove(),this.$buttons=this.$buttons.not(e);var i=this.$tabs.eq(t);i.remove(),this.$tabs=this.$tabs.not(i),this.render()},removeTabs:function(){for(var t=e(),i=e(),s=0;s<arguments.length;s++)t=t.add(this.$buttons.eq(arguments[s])),i=i.add(this.$tabs.eq(arguments[s]));t.remove(),i.remove(),this.$buttons=this.$buttons.not(t),this.$tabs=this.$tabs.not(i),this.render()},showTab:function(t){t>=this.$tabs.length||0>t||(this.currentTab=t,this.$tabs.hide().eq(t).show(),this.$buttons.removeClass("customer-chat-active").eq(t).addClass("customer-chat-active"),this.includeButtonInView(t),this.trigger("tab.show",t))},getButtonIndex:function(t){return this.$buttons.index(t)},getButton:function(t){return this.$buttons.eq(t)},includeButtonInView:function(t){this.$prev.hide(),this.$next.hide();var i=s.reduce(this.$buttons,function(t,i){return t+e(i).outerWidth(!0)},0),o=this.$container.width();if(i>o){var n=this.$buttons.eq(t),a=this.$buttonsContainer.position().left,r=n.position().left,h=n.outerWidth(),l=a;a+r<this.$prev.outerWidth()?(l=-r,0>l&&(l+=this.$prev.outerWidth()-1)):a+r+h>o-this.$next.outerWidth()&&(l=o-(r+h),l+i>o&&(l-=this.$next.outerWidth()-1)),0!==l&&this.$prev.show(),l+i>o&&this.$next.show(),this.$buttonsContainer.css("left",l)}else this.$buttonsContainer.css("left",0)},switchTab:function(t){var e=this.$buttons.index(t.currentTarget);this.showTab(e)},showTabForButton:function(t){this.switchTab({currentTarget:t})},prevButtons:function(){var t,e=this.$buttonsContainer.position().left;for(t=0;t<this.$buttons.length;t++){var i=this.$buttons.eq(t),s=i.position();if(s.left+=e,s.left<0&&0<s.left+i.outerWidth())break}this.includeButtonInView(t)},nextButtons:function(){var t,e=this.$buttonsContainer.position().left,i=this.$container.width();for(t=this.$buttons.length-1;t>=0;t--){var s=this.$buttons.eq(t),o=s.position();if(o.left+=e,o.left<i&&i<o.left+s.outerWidth())break}this.includeButtonInView(t)},render:function(){var t=Math.max(Math.min(this.currentTab,this.$tabs.length-1),0);this.showTab(t)},updateOnResize:function(){var t=null,i=e.proxy(this.render,this),s=this;this.$window.resize(function(){(s.$window.width()!==s.prevWinSize.width||s.$window.height()!==s.prevWinSize.height)&&(s.prevWinSize={width:s.$window.width(),height:s.$window.height()},t&&clearTimeout(t),t=setTimeout(i,500))})}})}(window.Application,jQuery,window.chatConfig,_),function(t,e,i){t.MenuView=Backbone.View.extend({events:{"mousedown #customer-chat-side-button-chat":"showChat","mousedown #customer-chat-side-button-settings":"showSettings","mousedown #customer-chat-side-button-logs":"showLogs","mousedown #customer-chat-header-menu-widget-snippet":"showWidgetSnippet","mousedown #customer-chat-side-button-widget-snippet":"showWidgetSnippet","click #customer-chat-header-menu-edit":"editProfile","click #customer-chat-header-menu-logs":"showLogs"},msgBlinking:!1,initialize:function(s){this.settings=t.model.settings,this.user=t.model.user,this.chat=t.model.chat,this.operatorsView=s.windowView.operatorsView,this.tabsView=s.windowView.tabsView,this.$window=e(window),this.$menu=this.$(".customer-chat-header-menu"),this.$button=this.$("#customer-chat-button-menu"),this.$editProfile=this.$("#customer-chat-header-menu-edit"),this.$install=this.$("#customer-chat-header-menu-install"),this.$uninstall=this.$("#customer-chat-header-menu-uninstall"),this.$editConfig=this.$("#customer-chat-header-menu-edit-config"),this.$menuLogs=this.$("#customer-chat-header-menu-logs"),this.$widgetSnippet1=this.$("#customer-chat-header-menu-widget-snippet"),this.$widgetSnippet2=this.$("#customer-chat-side-button-widget-snippet"),this.$sideMarker=this.$(".customer-chat-side-menu-triangle"),this.$msgIcon=this.$("#customer-chat-side-button-chat i"),this.$sideLogs=this.$("#customer-chat-side-button-logs"),this.$chat=this.$("#customer-chat-admin-chat"),this.$settings=this.$("#customer-chat-admin-settings"),this.$logs=this.$("#customer-chat-admin-logs"),this.user.hasRole("ADMIN")?(i.ui.installed?this.$install.hide():this.$uninstall.hide(),this.$editProfile.hide()):(this.$install.hide(),this.$uninstall.hide(),this.$editConfig.hide(),this.$menuLogs.hide(),this.$sideLogs.hide(),this.$widgetSnippet1.hide(),this.$widgetSnippet2.hide()),this.hide(),this.user.hasRole("OPERATOR")&&(this.listenTo(s.windowView.chatTabView,"talks.read",this.stopAnimateMsgIcon),this.listenTo(s.windowView.chatTabView,"talks.unread",this.animateMsgIcon)),this.listenTo(this.user,"change",this.updateUser),this.updateUser()},updateUser:function(){this.$button.find(".customer-chat-header-button-text").html("Welcome, "+this.user.getReadableName())},blinkMsgIcon:function(){if(this.msgBlinking){var t=this;this.$msgIcon.fadeOut("slow",function(){t.$msgIcon.fadeIn("slow",function(){t.blinkMsgIcon()})})}},animateMsgIcon:function(){this.msgBlinking=!0,this.blinkMsgIcon()},stopAnimateMsgIcon:function(){this.msgBlinking=!1},show:function(t){this.$menu.fadeIn("fast"),t.stopImmediatePropagation(),e("html, body").one("mousedown",e.proxy(this.hide,this))},hide:function(){this.$menu.fadeOut("fast"),this.$button.one("mousedown",e.proxy(this.show,this))},showChat:function(i){var s=18+i.currentTarget.offsetTop;this.$sideMarker.animate({top:s},"fast"),this.$chat.show(),this.$settings.hide(),this.$logs.hide(),e(window).resize(),t.trigger("menu:show:chat")},showSettings:function(e){var i=18+(e?e.currentTarget:this.$("#customer-chat-side-button-settings")[0]).offsetTop;this.$sideMarker.animate({top:i},"fast"),this.$chat.hide(),this.$settings.show(),this.$logs.hide(),this.tabsView.render(),this.$("#customer-chat-admin-settings .customer-chat-content-messages").mCustomScrollbar("update"),t.trigger("menu:show:settings")},showLogs:function(e){var i=18+this.$sideLogs[0].offsetTop;this.$sideMarker.animate({top:i},"fast"),this.$chat.hide(),this.$settings.hide(),this.$logs.show(),this.$("#customer-chat-admin-logs .customer-chat-content-messages").mCustomScrollbar("update"),t.trigger("menu:show:logs")},editProfile:function(){var t=this.$("#customer-chat-side-button-settings")[0];this.showSettings({currentTarget:t}),this.chat.operatorsReady?this._editProfile():this.listenToOnce(this.chat,"change:operators",function(){this._editProfile()})},_editProfile:function(){this.operatorsView.showEdit(null,this.user.get("id")),this.tabsView.showTab(this.user.hasRole("OPERATOR")?0:1)},showWidgetSnippet:function(){var e='<code>&lt;script type="text/javascript" src="'+i.widgetInitPath+'"&gt;&lt;/script&gt;</code>';t.view.dialogs.message("Widget embedding code",e)}})}(window.Application,jQuery,window.chatConfig),function(t,e,i){t.ChatTabView=Backbone.View.extend({events:{"click .customer-chat-tab-button .close":"closeTalk","click .customer-chat-history-item":"showTalk"},talks:{},unreadTalks:0,initialize:function(){this.settings=t.model.settings,this.chat=t.model.chat,this.user=t.model.user,this.tabsView=new t.TabsView({el:this.$(".chat-wrapper")}),this.chatBox=new t.ChatBoxView({el:this.$(".customer-chat-content-messages")}),this.$emoticons=this.$(".customer-chat-emots-menu"),this.$input=this.$(".customer-chat-content-message-input-field"),this.$onlineList=this.$("#customer-chat-users-online .customer-chat-content-messages-wrapper.users"),this.$onlineListOperator=this.$("#customer-chat-users-online .customer-chat-content-messages-wrapper.operators"),this.user.hasRole("ADMIN")&&(this.tabsView.remove(),this.$("#customer-chat-users-online").addClass("admin")),this.listenTo(this.chat,"users:online",this.renderOnlineUsers),this.listenTo(this.chat,"messages:new",this.handleNewMessages),this.listenTo(this.tabsView,"tab.show",function(){e(window).resize()}),this.listenTo(this.tabsView,"tab.show",this.handleTalkShown),this.listenTo(t,"menu:show:chat",this.handleChatShown)},renderOnlineUsers:function(i){this.$onlineList.html(""),this.$onlineListOperator.html("");for(var s=0;s<i.length;s++){var o=i[s],n=new t.UserModel(o),a=e(t.template.historyListItem);a.data("info",n),a.find(".customer-chat-history-item-username").html(n.getReadableName()),-1!==o.roles.indexOf("OPERATOR")?this.$onlineListOperator.append(a):this.$onlineList.append(a),new t.UserInfoPopoverView({model:n,button:a[0]});var r=this.getTalkWith(n);r&&r.chatView.model.set(n.attributes)}e(window).trigger("resize")},addTalk:function(i){var s=e(t.template.tabButtonChat);s.find("span").html(i.user.getReadableName()),s.data("user",i.user);var o=s.find(".new-msg");o.hide(),function h(){o.animate({opacity:.01},{duration:"slow",complete:function(){o.animate({opacity:1},{duration:"slow",complete:h})}})}();var n=e(t.template.tabContentChat),a=new t.ChatView({el:n,model:i.user});this.tabsView.addTab({button:s,content:n});var r={chatView:a,$button:s};return this.talks[i.user.get("id")]=r,this.listenTo(a,"message.sent",this.handleMessageSent),r},removeTalkWith:function(t){var e=this.talks[t.get("id")];this.tabsView.removeTab(this.tabsView.getButtonIndex(e.$button[0])),e.chatView.remove(),delete this.talks[t.get("id")]},hasTalkWith:function(t){return!!this.talks[t.get("id")]},getTalkWith:function(t){return this.talks[t.get("id")]},showTalk:function(i){var s=e(i.currentTarget).data("info");if(this.user.hasRole("ADMIN"))return void t.trigger("history.search",{name:s.get("name"),mail:s.get("mail"),fromDate:"",toDate:""});var o=this.getTalkWith(s);o||(o=this.addTalk({user:s}),this.chat.getLastMessages(s.get("id"),null,function(t){t.length>0&&o.chatView.handleNewMessages(t,!0)})),this.tabsView.showTabForButton(o.$button[0])},closeTalk:function(t){var i=e(t.currentTarget).parent(".customer-chat-tab-button").data("user");this.removeTalkWith(i),t.stopImmediatePropagation()},handleNewMessages:function(e){var i=_.groupBy(e,"from_id");_.each(i,function(e){var i=new t.UserModel(e[0].from_user_info),s=this.getTalkWith(i);if(s)this.initTalk(s,e);else{s=this.addTalk({user:i});var o=e[0],n=this;this.chat.getLastMessages(i.get("id"),o.id,function(t){t.length>0&&s.chatView.handleNewMessages(t,!0),n.initTalk(s,e)})}},this)},initTalk:function(t,e){t.chatView.handleNewMessages(e);var i=t.$button.find(".new-msg");i.is(":hidden")&&(i.show(),this.updateUnreadCounter(1))},handleMessageSent:function(e){var i=this.getTalkWith(new t.UserModel({id:e.get("to")})),s=i.$button.find(".new-msg");s.is(":visible")&&(s.hide(),this.updateUnreadCounter(-1))},handleTalkShown:function(t){var e=this.tabsView.getButton(t).find(".new-msg");e.is(":visible")&&(e.hide(),this.updateUnreadCounter(-1))},handleChatShown:function(){this.tabsView.render()},updateUnreadCounter:function(t){var e=this.unreadTalks;this.unreadTalks=Math.max(0,this.unreadTalks+t),this.trigger(1===e&&0===this.unreadTalks?"talks.read":"talks.unread")}})}(window.Application,jQuery,window.chatConfig),function(t,e,i,s){var o=t.ChatView=Backbone.View.extend({events:{"click .customer-chat-content-message-emots-button":"toggleEmoticons","click .customer-chat-emoticon":"addEmoticon","keydown .customer-chat-content-message-input-field":"sendMessage"},typingInfoBlinking:!1,initialize:function(){this.settings=t.model.settings,this.chat=t.model.chat,this.user=t.model.user,this.chatBox=new t.ChatBoxView({el:this.$(".customer-chat-content-messages")}),this.$emoticons=this.$(".customer-chat-emots-menu"),this.$typingInfo=this.$(".typing-indicator"),this.$input=this.$(".customer-chat-content-message-input-field"),this.model.hasRole("OPERATOR")&&this.$el.addClass("operator"),this.listenTo(this.chat,"messages:sent",this.handleMessageSent),this.listenTo(this.model,"change",this.handleModelUpdate),this.handleModelUpdate(),this.listenTo(this.chat,"users:typing",this.handleRemoteTyping)},toggleEmoticons:function(){this.$emoticons.toggle("fade","fast")},addEmoticon:function(t){var i=e(t.currentTarget);this.$input.val(this.$input.val()+" "+i.data("emot")+" "),this.$input.focus(),this.$emoticons.fadeOut("fast")},sendMessage:function(e){if(this.handleTyping(),13===e.keyCode&&!e.shiftKey){var i=this.$input.val();if(0!=i.length){var s=new t.MessageModel({author:this.user.get("name"),mail:this.user.get("mail"),authorType:"operator",body:i,time:new Date,to:this.model.get("id")},{localMessage:!0});s.fromUser=this.user.attributes,this.chat.sendMessage(s),this.chatBox.addMessage(s,!0),this.$input.val(""),this.trigger("message.sent",s)}}},handleMessageSent:function(e,i){if(e===this.model.get("id")&&-2===i.to_id){i.from_user_info.image="no_image.jpg";var s=new t.MessageModel({author:"[system message]",body:"Another operator is already helping this guest, your messages will not be delivered.",datetime:new Date,image:"#",from_user_info:i.from_user_info});this.chatBox.addMessage(s,!0)}},handleNewMessages:function(e,i){s.each(e,this.handleMessage,this),!i&&e.length>0&&this.settings.get("sound")&&t.service.soundPlayer.play("message")},handleMessage:function(e){e.info=this.model.get("info");var i=new t.MessageModel(e);this.chatBox.addMessage(i)},handleTyping:function(){this.chat.updateTypingStatus(this.model.get("id"))},handleRemoteTyping:function(t){-1!==t.indexOf(this.model.get("id"))&&(this.startTypingInfoBlink(),this.stopTypingBlinkTimer&&clearTimeout(this.stopTypingBlinkTimer),this.stopTypingBlinkTimer=setTimeout(e.proxy(this.stopTypingInfoBlink,this),o.TYPING_STATUS_TIME))},handleModelUpdate:function(){},startTypingInfoBlink:function(){this.typingInfoBlinking||(this.typingInfoBlinking=!0,this.blinkTypingInfo())},blinkTypingInfo:function(){if(this.typingInfoBlinking){var t=this;this.$typingInfo.fadeIn("slow",function(){t.$typingInfo.fadeOut("slow",function(){t.blinkTypingInfo()})})}},stopTypingInfoBlink:function(){this.typingInfoBlinking=!1}},{TYPING_STATUS_TIME:2e3})}(window.Application,jQuery,window.chatConfig,_),function(t,e){t.SettingsView=Backbone.View.extend({mailExp:new RegExp("^[-+\\.0-9=a-z_]+@([-0-9a-z]+\\.)+([0-9a-z]){2,}$","i"),colorExp:new RegExp("^#(([0-9a-fA-F]{3})|([0-9a-fA-F]{6}))$"),events:{"click #customer-chat-ui-save":"save","click #customer-chat-ui-reset":"reset","change #inputMsgSound":"playSound"},errors:!1,inputs:null,syncing:!1,initialize:function(){this.model=t.model.uiSettings,this.$inputs=this.$("*[name]"),this.$msgSound=this.$("#inputMsgSound"),this.$save=this.$("#customer-chat-ui-save"),this.$loading=this.$(".customer-chat-content-loading-icon").hide(),this.$inputs.blur(e.proxy(this.validate,this)),this.initColorPickers(),this.soundPlayer=t.service.soundPlayer;var i=this;this.$msgSound.find("option").each(function(){var t={};t[this.value]=this.value,i.soundPlayer.addSounds(t)}),this.model.on("change",this.render,this),this.model.on("request",this.disable,this),this.model.on("sync",this.enable,this),this.render()},validate:function(i,s){this.errors=!1;var o=this;this.$inputs.each(function(){var t=e(this);switch(t.removeClass("customer-chat-input-error"),t.data("validator")){case"color":0!=t.val().length&&o.colorExp.test(t.val())||(t.addClass("customer-chat-input-error"),o.errors=!0);break;case"mail":0!=t.val().length&&o.mailExp.test(t.val())||(t.addClass("customer-chat-input-error"),o.errors=!0);break;case"number":/^[\d]+$/.test(t.val())&&parseInt(t.val())>=0||(t.addClass("customer-chat-input-error"),o.errors=!0)}}),s&&this.errors&&t.view.dialogs.message("Form error","Some settings are invalid")},isValid:function(){return this.validate(null,!0),!this.errors},save:function(){if(this.isValid()){var t={};this.$inputs.each(function(){var i=e(this);t[i.attr("name")]="checkbox"==i.attr("type")?i.is(":checked")?"true":"false":i.val()}),this.syncing||this.model.save(t)}},reset:function(){var i=this;t.view.dialogs.confirm("Reset settings","Are you sure you want to reset all the settings?",{Reset:function(){i._reset(),e(this).dialog("close")}})},_reset:function(){this.model.reset()},render:function(){var t=this;this.$inputs.each(function(){var i=e(this);"checkbox"==i.attr("type")?"true"==t.model.get(i.attr("name"))?i.attr("checked","checked"):i.removeAttr("checked"):i.val(t.model.get(i.attr("name")))}),this.validate()},disable:function(){this.syncing=!0,this.$save.addClass("button-disabled"),this.$loading.fadeIn()},enable:function(){var t=this;setTimeout(function(){t.$save.removeClass("button-disabled"),t.$loading.fadeOut(),t.syncing=!1},500)},initColorPickers:function(){e(".color-input").each(function(){var t=e(this);t.ColorPicker({onSubmit:function(e,i,s){t.val("#"+i),t.ColorPickerHide()},onChange:function(e,i,s){t.val("#"+i),t.blur()},onBeforeShow:function(){t.ColorPickerSetColor(this.value)}}).bind("keyup",function(){t.ColorPickerSetColor(this.value)})})},playSound:function(){this.soundPlayer.play(this.$msgSound.val())}})}(window.Application,jQuery),function(t,e){t.LogsView=Backbone.View.extend({events:{"click #customer-chat-logs-refresh":"refresh","click #customer-chat-logs-clear":"clear"},syncing:!1,initialize:function(){this.model=t.model.logs,this.$scroller=this.$(".customer-chat-content-messages"),this.$wrapper=this.$(".customer-chat-content-messages-wrapper"),this.$refresh=this.$("#customer-chat-logs-refresh"),this.$clear=this.$("#customer-chat-logs-clear"),this.$loading=this.$(".customer-chat-content-loading-icon").hide(),this.$scroller.bind("show",function(){e(window).trigger("resize")}).mCustomScrollbar();var i=this;this.$scroller.bind("show",function(){i.init()}),this.$scroller.bind("hide",function(){i.clean()}),this.model.on("change",this.render,this),this.model.on("request",this.disable,this),this.model.on("sync",this.enable,this)},render:function(){this.$wrapper.html("<pre>"+this.model.get("content")+"</pre>");var t=this;setTimeout(function(){t.$scroller.mCustomScrollbar("update"),t.$scroller.mCustomScrollbar("scrollTo","bottom")},200)},disable:function(){this.syncing=!0,this.$refresh.addClass("button-disabled"),this.$clear.addClass("button-disabled"),this.$loading.fadeIn()},enable:function(){var t=this;setTimeout(function(){t.$refresh.removeClass("button-disabled"),t.$clear.removeClass("button-disabled"),t.$loading.fadeOut(),t.syncing=!1},500)},init:function(){if(this.model.has("content")){var t=this;setTimeout(function(){t.render()},200)}else this.model.fetch()},refresh:function(){this.syncing||this.model.fetch()},clean:function(){this.$wrapper.html("")},clear:function(){if(!this.syncing){var i=this;t.view.dialogs.confirm("Clear logs","Are you sure you want to clear all of the logs?",{Clear:function(){i._clear(),e(this).dialog("close")}})}},_clear:function(){this.model.clear(e.proxy(this.onClear,this.onClearError))},onClear:function(){t.view.dialogs.message("Clear logs","All logs cleared")},onClearError:function(){t.view.dialogs.message("Clear logs","Error clearing the logs")}})}(window.Application,jQuery),function(t,e,i,s){t.OperatorsView=Backbone.View.extend({mailExp:new RegExp("^[-+\\.0-9=a-z_]+@([-0-9a-z]+\\.)+([0-9a-z]){2,}$","i"),events:{"click #customer-chat-operators-back":"showList","click #customer-chat-operators-add":"showAdd","click #customer-chat-operators-change-password":"showChangePassword","click #customer-chat-operators-cancel":"showEdit","click .customer-chat-operators-edit":"showEdit","click .customer-chat-operators-remove":"deleteOperator","click #customer-chat-operators-save":"save"},initialize:function(){this.model=t.model.chat,this.user=t.model.user,this.$list=this.$("#customer-chat-operators-list"),this.$operators=this.$list.find(".customer-chat-content-messages-wrapper"),this.$edit=this.$("#customer-chat-operators-edit"),this.$save=this.$("#customer-chat-operators-save"),this.$back=this.$("#customer-chat-operators-back"),this.$editInputs=this.$edit.find("input"),this.$loading=this.$(".customer-chat-content-loading-icon").hide(),this.user.hasRole("OPERATOR")&&(this.$back.remove(),this.listenToOnce(this.model,"change:operators",function(){this.showEdit(null,this.user.get("id"))})),this.$editInputs.blur(e.proxy(this.validateEdit,this)),this.model.on("change:operators",this.render,this),this.showList(),this.render(),this.model.loadOperators()},render:function(){this.$operators.html("");var s=this;i.each(this.model.getOperators(),function(i){var o=e(t.template.operatorItem);o.find(".customer-chat-operator-name").html(i.name),o.find(".customer-chat-operator-mail").html(i.mail),o.find(".customer-chat-operators-edit").data("id",i.id),
o.find(".customer-chat-operators-remove").data("id",i.id),s.$operators.append(o)})},showList:function(){this.state="list",this.$edit.hide(),this.$list.show(),this.enable()},showEdit:function(i,s){var o=this.state;this.state="edit",this.$edit.find(".add-only, .pass-only").hide(),this.$edit.find(".edit-only").show(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error");var n,a,r=i?e(i.currentTarget):null;"pass"!==o?(n=r?r.data("id"):s,a=t.model.selectedOperator=t.model.chat.getOperator(n)):(a=t.model.selectedOperator,n=a.id),this.$edit.find(".customer-chat-tabs-header").html(this.user.get("id")===s?"Edit profile":"Edit operator"),a&&(this.$edit.find("#usernameField").val(a.name),this.$edit.find("#mailField").val(a.mail)),this.$list.hide(),this.$edit.show()},deleteOperator:function(i){var s=e(i.currentTarget),o=t.model.chat.getOperator(s.data("id")),n=this,a={};a['Remove "%user%"'.replace("%user%",o.name)]=function(){n.model.deleteOperator(o),e(this).dialog("close"),e(window).trigger("resize")},t.view.dialogs.confirm('Remove "%user%"?'.replace("%user%",o.name),"Are you sure you want to permanently delete this user?",a)},showAdd:function(){this.state="add",this.$edit.find(".customer-chat-tabs-header").html("Add new operator"),this.$edit.find(".edit-only, .pass-only").hide(),this.$edit.find(".add-only").show(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error"),t.model.selectedOperator={roles:["OPERATOR"]},this.$edit.find("#usernameField").val(""),this.$edit.find("#mailField").val(""),this.$edit.find("#passField").val(""),this.$edit.find("#rePassField").val(""),this.$list.hide(),this.$edit.show()},showChangePassword:function(){this.state="pass",this.$edit.find(".customer-chat-tabs-header").html("Change password"),this.$edit.find(".edit-only, .add-only").hide(),this.$edit.find(".pass-only").show(),this.user.hasRole("ADMIN")&&this.$edit.find(".current-pass").hide(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error"),this.$edit.find("#changePassCurrentField").val(""),this.$edit.find("#changePassField").val(""),this.$edit.find("#changePassRetypeField").val(""),this.$list.hide(),this.$edit.show()},save:function(){if(this.isEditValid()&&!this.syncing){this.disable();var e=t.model.selectedOperator;if(e){"edit"==this.state||"add"==this.state?(e.name=this.$edit.find("#usernameField").val(),e.mail=this.$edit.find("#mailField").val(),e.password=this.$edit.find("#passField").val()):"pass"==this.state&&(e.currPassword=this.$edit.find("#changePassCurrentField").val(),e.password=this.$edit.find("#changePassField").val());var s=this;t.model.chat.once("operator:saved",function(t){s.enable(),s.user.hasRole("ADMIN")?s.showList():s.showEdit()}),t.model.chat.once("operator:saveError",function(e){s.enable(),t.view.dialogs.formError("Form error",i.values(e))}),t.model.chat.saveOperator(e)}else this.enable()}},disable:function(){this.syncing=!0,this.$save.addClass("button-disabled"),this.$loading.fadeIn()},enable:function(){var t=this;setTimeout(function(){t.$save.removeClass("button-disabled"),t.$loading.fadeOut(),t.syncing=!1,"add"==t.state&&t.showList()},500)},validateEdit:function(i,s){function o(t,e){if(t.addClass("customer-chat-input-error"),t.data("validator-msg")!==!1){var i=t.data("validator-label");i&&(e=i+": "+e),n.errors.push(e)}else n.errors.push(!1)}this.errors=!1;var n=this,a=s?this.$editInputs:e(i.target);if(!s){var r=e(i.target).data("validator-match");r&&(a=a.add(n.$el.find("#"+r)))}n.errors=[],a.each(function(){var t=e(this),i=t.data("validator-state"),s=t.data("validator-state-ex");if(!(i&&i!==n.state||s&&s===n.state)){switch(t.removeClass("customer-chat-input-error"),t.data("validator")){case"mail":0!=t.val().length&&n.mailExp.test(t.val())||o(t,"Enter valid e-mail address");break;case"notEmpty":0==t.val().length&&o(t,"Value cannot be empty");break;case"password":t.val().length<6&&o(t,"Password has to be at least 6 characters long")}var a=t.data("validator-match");if(a){var r=n.$el.find("#"+a);t.val()!==r.val()&&o(t,"Passwords have to match")}}}),s&&this.errors.length>0&&t.view.dialogs.formError("Form error",this.errors)},isEditValid:function(){return this.validateEdit(null,!0),0===this.errors.length}})}(window.Application,jQuery,_,window.chatConfig),function(t,e,i){var s=t.HistoryView=Backbone.View.extend({events:{"click #customer-chat-history-search":"search","click #customer-chat-history-clear":"clear","keydown input":"searchOnEnter","click .customer-chat-history-item":"showConversation","click #history-list-display-more":"displayMoreResults"},searching:!1,lastSearch:{items:[],displayed:0},initialize:function(){this.model=t.model.chat,this.$results=this.$("#customer-chat-history-search-results"),this.$inputs=this.$("*[name]"),this.$search=this.$("#customer-chat-history-search"),this.$clear=this.$("#customer-chat-history-clear"),this.$loading=this.$(".customer-chat-content-loading-icon").hide(),this.$resultItems=this.$("#customer-chat-history-search-results .customer-chat-content-messages-wrapper"),this.$displayMore=e(t.template.historyListDisplayMore),this.$chatHeader=this.$("#customer-chat-talk-header"),this.$headerUser1=this.$("#history-chat-user-1"),this.$headerId1=this.$("#history-chat-id-1"),this.$headerMail1=this.$("#history-chat-mail-1"),this.$headerUser2=this.$("#history-chat-user-2"),this.$headerId2=this.$("#history-chat-id-2"),this.$headerMail2=this.$("#history-chat-mail-2"),this.$headerDate=this.$chatHeader.find(".date-info"),this.$(".date-input").datepicker(),this.$results.mCustomScrollbar();var i=this.user=t.model.user;i.hasRole("ADMIN")||this.$clear.hide(),this.chatBoxView=new t.ChatBoxView({el:this.$("#history-results-chat"),model:new t.ChatViewModel,fullDate:!0}),this.model.on("change",this.render,this),this.model.on("request",this.disable,this),this.model.on("sync",this.enable,this),this.listenTo(t,"history.search",this.autoSearch),this.render()},search:function(){if(!this.searching){this.searching=!0,this.clearSearchResults();var t={};this.$inputs.each(function(){var i=e(this);i.val()&&(t[i.attr("name")]="checkbox"==i.attr("type")?i.is(":checked")?"true":"false":i.val())}),this.model.queryHistory(t,e.proxy(this.onQueryResults,this),e.proxy(this.onQueryError,this))}},searchOnEnter:function(t){13===t.which&&this.search()},clear:function(){var i=this;t.view.dialogs.confirm("Clear history","Are you sure you want to clear all of the messages?",{"Clear messages":function(){i._clear(),e(this).dialog("close")}})},_clear:function(){this.chatBoxView.clear(),this.$chatHeader.hide(),this.clearSearchResults(),this.model.clearHistory(e.proxy(this.onClear,this),e.proxy(this.onClearError))},autoSearch:function(t){this.$inputs.each(function(){var i=e(this),s=i.attr("name");void 0!==typeof t[s]&&i.val(t[s])}),this.search()},onQueryError:function(){this.searching=!1},onQueryResults:function(t){this.searching=!1,this.prepareResults(t),this.lastSearch.items=t,this.lastSearch.displayed=0,this.clearSearchResults(),this.displayMoreResults()},onClearError:function(){t.view.dialogs.message("Clear history","Error clearing the history")},onClear:function(){t.view.dialogs.message("Clear history","Message history cleared")},displayMoreResults:function(){var t=this.lastSearch.items,e=this.lastSearch.displayed;if(e<t.length){var i=Math.max(0,Math.min(t.length,e+s.RESULTS_DISPLAY_COUNT));this.addSearchResults(t.slice(e,i)),e=i}t.length>e?this.$resultItems.append(this.$displayMore.show()):this.$displayMore.remove(),this.$results.mCustomScrollbar("update"),this.lastSearch.displayed=e},render:function(){return this},setSearchResults:function(t){this.clearSearchResults(),this.addSearchResults(t)},addSearchResults:function(t){for(var e=0;e<t.length;e++)this.addSearchResult(t[e])},clearSearchResults:function(){this.$resultItems.html(""),this.$results.mCustomScrollbar("update")},addSearchResult:function(s){var o=s[0],n=e(t.template.historyListItem),a=new Date(o.datetime),r=a.getDate()<10?"0"+a.getDate():a.getDate(),h=a.getMonth()+1<10?"0"+(a.getMonth()+1):a.getMonth()+1,l=isNaN(a.getDay())?"":r+"."+h+"."+a.getFullYear(),c=new t.MessageModel(o);n.find(".customer-chat-history-item-username").html(c.getTalkName()),n.find(".customer-chat-history-item-time").html(l);var d=i.clone(c.attributes);d.author=d.author+" ("+d.authorMail+")",n.data("info",s),this.$resultItems.append(n),this.$results.mCustomScrollbar("update")},showConversation:function(i){this.chatBoxView.clear();var s=e(i.currentTarget),o=s.data("info"),n=new t.MessageModel(o[0]),a=new t.MessageModel(o[o.length-1]);this.$headerUser1.html(n.getReadableName()),this.$headerId1.html(n.get("author")),this.$headerMail1.html(n.get("authorMail")),this.$headerUser2.html(n.getToUserReadableName()),this.$headerId2.html(n.get("toAuthor")),this.$headerMail2.html(n.get("toAuthorMail")),this.$headerDate.html(n.get("datetime")+" — "+a.get("datetime")),this.$chatHeader.show(),o.sort(function(t,e){return t.datetime>e.datetime?1:-1});for(var r=0;r<o.length;r++){var h=o[r];h.info=h.from_user_info.info,this.chatBoxView.addMessage(new t.MessageModel(h),!1,!0)}},prepareResults:function(t){for(var e=0;e<t.length;e++){var i=t[e];i.roles&&-1!==i.roles.toLowerCase().indexOf("guest")&&(i.name=-1!==i.name.lastIndexOf("-")?i.name.slice(0,i.name.lastIndexOf("-")):i.name)}}},{RESULTS_DISPLAY_COUNT:20})}(window.Application,jQuery,_),function(t,e,i){var s=t.WindowView=Backbone.View.extend({initialize:function(){this.settings=t.model.settings;var i=this.user=t.model.user;i.hasRole("ADMIN")&&(this.settingsView=new t.SettingsView({el:this.$(".customer-chat-tab-content-settings-ui")}),this.logsView=new t.LogsView({el:this.$("#customer-chat-admin-logs")})),this.chatTabView=new t.ChatTabView({el:this.$("#customer-chat-admin-chat")}),this.operatorsView=new t.OperatorsView({el:this.$("#customer-chat-operators-tab")}),this.historyView=new t.HistoryView({el:this.$("#customer-chat-history")}),this.tabsView=new t.TabsView({el:this.$("#customer-chat-admin-settings")}),this.menuView=new t.MenuView({el:this.el,windowView:this}),i.hasRole("ADMIN")||(this.tabsView.removeTab(0),this.$(".customer-chat-tab-button.operators").html("Edit profile")),this.user.hasRole("OPERATOR")&&(this.titleText=document.title,this.listenTo(this.chatTabView,"talks.read",this.stopMsgIndicator),this.listenTo(this.chatTabView,"talks.unread",this.startMsgIndicator)),this.$("#customer-chat-admin-settings .customer-chat-content-messages").bind("show",function(){e(window).trigger("resize")}).not("#customer-chat-history .customer-chat-content-messages").mCustomScrollbar(),window.alert=function(e){t.view.dialogs.message("Alert",e)},this.$el.animate({opacity:1},{duration:"slow",complete:this.checkInstall}),this.listenTo(t,"history.search",this.showHistory)},showHistory:function(){this.menuView.showSettings(),this.tabsView.showTab(this.user.hasRole("OPERATOR")?2:4)},startMsgIndicator:function(){this.msgIndicatorTimer||(this.msgIndicatorTimer=setInterval(e.proxy(this.indicateMsg,this),s.MSG_INDICATOR_INTERVAL))},stopMsgIndicator:function(){this.msgIndicatorTimer&&(clearInterval(this.msgIndicatorTimer),document.title=this.titleText,delete this.msgIndicatorTimer)},indicateMsg:function(){document.title="!"!==document.title?"!":this.titleText},checkInstall:function(){i.installStatus.validConfig&&i.installStatus.validDb||(t.model.user.hasRole("ADMIN")?t.view.dialogs.confirm("Incorrect installation",t.template.invalidInstallDialogContent,{"Edit configuration":function(){(document.location||window.location).href=i.installWizardPath}}):t.view.dialogs.message("Please install first","The application is not yet installed, please log in as administrator and install it before using")),i.ui.installed||(t.model.user.hasRole("ADMIN")?t.view.dialogs.confirm("Install",t.template.installDialogContent,{Install:function(){(document.location||window.location).href=i.installPath}}):t.view.dialogs.message("Please install first","The application is not yet installed, please log in as administrator and install it before using"))}},{MSG_INDICATOR_INTERVAL:1e3})}(window.Application,jQuery,window.chatConfig),function(t,e){t.DialogsView=Backbone.View.extend({initialize:function(){this.$confirm=e(t.template.confirmDialog),this.$formError=e(t.template.formErrorDialog)},confirm:function(i,s,o,n){s&&(s instanceof Backbone.View?this.$confirm.html("").append(s.render().el):this.$confirm.html(s)),o.Cancel||(o.Cancel=function(){e(this).dialog("close")}),this.$confirm.dialog({title:i,resizable:!1,modal:!0,width:n?n:400,maxWidth:900,height:"auto",buttons:o,show:"fade",position:{of:t.view.window.$el}})},formError:function(i,s){this.$formError.html("");for(var o=0;o<s.length;o++){var n=e("<p>"),a=s[o];a&&a.length>0&&n.html(s[o]),this.$formError.append(n)}this.$formError.dialog({title:i,resizable:!1,modal:!0,width:400,height:"auto",buttons:{Close:function(){e(this).dialog("close")}},show:"fade",position:{of:t.view.window.$el}})},message:function(i,s){this.$formError.html("<p>"+s+"</p>"),this.$formError.dialog({title:i,resizable:!1,modal:!0,width:400,height:"auto",buttons:{Close:function(){e(this).dialog("close")}},show:"fade",position:{of:t.view.window.$el}})}})}(window.Application,jQuery),function(t,e,i){t.UserInfoPopoverView=Backbone.View.extend({initialize:function(t){var e=i(t.button);e.popover({placement:"top",trigger:"manual",container:"body",title:"User info",html:!0,content:this.render().$el}).mouseenter(function(){var t=i(this);i("body > .popover").remove(),t.popover("show");var e=i("body > .popover");t.add(e).bind("mouseleave",function(){setTimeout(function(){e.underMouse()||e.remove()},250)})})},render:function(){return this.$el.html(t.template.userInfoPopoverContent),this.$("#user-popover-name").html(this.model.getReadableName()),this.$("#user-popover-id").html(this.model.get("author")||this.model.get("name")),this.$("#user-popover-mail").html(this.model.get("authorMail")||this.model.get("mail")),this.$("#user-popover-ip").html(this.model.has("info")?this.model.get("info").ip:"PRIVATE"),this.model.has("info")||this.$("#user-popover-ip").parent().hide(),this}})}(window.Application,chatConfig,jQuery),jQuery(function(t){var e=window.chatConfig;t.get(e.templatesPath,function(e){var i=t(e),s=window.Application;s.service.soundPlayer=new s.SoundPlayer,s.template.message=i.find("#message").html(),s.template.operatorItem=i.find("#operator-item").html(),s.template.installDialogContent=i.find("#dialog-install-content").html(),s.template.invalidInstallDialogContent=i.find("#dialog-invalid-install-content").html(),s.template.confirmDialog=i.find("#dialog-confirm").html(),s.template.formErrorDialog=i.find("#dialog-form-error").html(),s.template.historyListItem=i.find("#history-list-item").html(),s.template.historyListDisplayMore=i.find("#history-list-display-more").html(),s.template.userInfoPopoverContent=i.find("#user-info-popover-content").html(),s.template.tabButtonChat=i.find("#tab-button-chat").html(),s.template.tabContentChat=i.find("#tab-content-chat").html(),s.model.user=new s.UserModel(window.userData),s.model.uiSettings=new s.UISettingsModel,s.model.logs=new s.LogsModel,s.model.settings=new s.AdminSettingsModel,s.model.chat=new s.AdminChatModel,s.model.user.listenTo(s.model.chat,"operator:saved",function(t){t.id===this.get("id")&&this.set(t)}),s.view.dialogs=new s.DialogsView,s.view.window=new s.WindowView({el:"#customer-chat",model:s.model.chat})})});